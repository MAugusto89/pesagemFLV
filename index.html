<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pesagem | Exportação PDF</title>
    <!-- Carregando Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carregando React, ReactDOM e Babel para executar o JSX no navegador -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Estilos específicos para impressão (PDF) */
        @media print {
            body {
                margin: 0;
                padding: 0;
                /* Usar cores pretas para impressão */
                color: #000;
                background: #fff;
            }
            .print\:hidden {
                display: none !important;
            }
            .print\:block {
                display: block !important;
            }
            .print\:text-2xl {
                font-size: 1.5rem; /* 24px */
            }
            .print\:mb-4 {
                margin-bottom: 1rem;
            }
            .print\:text-lg {
                font-size: 1.125rem; /* 18px */
            }
            .print\:font-bold {
                font-weight: 700;
            }
            .print\:text-gray-900 {
                color: #1f2937;
            }
            /* Garantir que a tabela não quebre */
            .print-table {
                width: 100%;
                border-collapse: collapse;
            }
            .print-table th, .print-table td {
                padding: 8px;
                border: 1px solid #ccc;
            }
        }
        /* Garantir que a página de impressão tenha um layout limpo */
        .no-print-margin {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 no-print-margin">
    <div id="root"></div>

    <script type="text/babel">
        // Definições de Ícones
        const Printer = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M6 9V2h12v7" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><path d="M6 14h12v8H6z" />
            </svg>
        );
        const Sparkles = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9 1.9 5.8 1.9-5.8 5.8-1.9-5.8-1.9z" />
                <path d="M5 21v-3" /><path d="M19 21v-3" /><path d="M3 5h3" /><path d="M21 5h-3" />
                <path d="M12 17.5.5 23.5" /><path d="M12 17.5 23.5 23.5" />
                <path d="m12 6.5-.5-5.5" /><path d="m12 6.5.5-5.5" />
            </svg>
        );
        const Loader2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            </svg>
        );
        const PlusCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" />
            </svg>
        );

        // Função utilitária para chamar a API com Backoff Exponencial
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        // --- BASE DE DADOS COMPLETA ---
        const parsedData = [
            { cod: 1898, name: 'Flv Abacate Kg' }, { cod: 1892, name: 'Flv Abacaxi Un' }, { cod: 4643, name: 'Flv Abobora Cabotian Inteiro Kg' },
            { cod: 4791, name: 'Flv Abobora Moranga Kg' }, { cod: 4631, name: 'Flv Abobora Paulista Kg' }, { cod: 4627, name: 'Flv Abobrinha Verde Kg' },
            { cod: 4942, name: 'Flv Acelga Un' }, { cod: 82858, name: 'Flv Alface Americano Un' }, { cod: 4632, name: 'Flv Alho Granel Kg' },
            { cod: 1908, name: 'Flv Ameixa Kg' }, { cod: 2065, name: 'Flv Banana Maca Kg' }, { cod: 1956, name: 'Flv Banana Nanica Kg' },
            { cod: 2028, name: 'Flv Banana Prata Kg' }, { cod: 2059, name: 'Flv Banana Terra Kg' }, { cod: 4633, name: 'Flv Batata Doce Kg' },
            { cod: 1632, name: 'Flv Batata Lavada Tradicional Kg' }, { cod: 4636, name: 'Flv Beringela Kg' }, { cod: 4640, name: 'Flv Beterraba Kg' },
            { cod: 6094, name: 'Flv Brocolis Un' }, { cod: 2073, name: 'Flv Caqui Kg' }, { cod: 4650, name: 'Flv Cebola Kg' },
            { cod: 3524, name: 'Flv Cebola Roxa Kg' }, { cod: 4652, name: 'Flv Cenoura Kg' }, { cod: 4654, name: 'Flv Chuchu Kg' },
            { cod: 2082, name: 'Flv Coco Da Bahia Kg Seco' }, { cod: 12576, name: 'Flv Coco Da Bahia Verde Un' }, { cod: 42690, name: 'Flv Couve Flor Un' },
            { cod: 4656, name: 'Flv Gengibre Kg' }, { cod: 2083, name: 'Flv Goiaba Kg' }, { cod: 4660, name: 'Flv Inhame Kg' },
            { cod: 4676, name: 'Flv Jilo Kg' }, { cod: 2107, name: 'Flv Kiwi Kg' }, { cod: 14176, name: 'Flv Laranja Bahia Kg' },
            { cod: 2137, name: 'Flv Laranja Granel Kg' }, { cod: 2233, name: 'Flv Laranja Lima Kg' }, { cod: 2252, name: 'Flv Laranja Pct 3kg' },
            { cod: 29997, name: 'Flv Limao Siciliano Kg' }, { cod: 2254, name: 'Flv Limao Taiti Kg' }, { cod: 2262, name: 'Flv Maca Nacional Kg' },
            { cod: 2260, name: 'Flv Maca Red Argentina Kg' }, { cod: 41048, name: 'Flv Maca t Monica 1kg' }, { cod: 2270, name: 'Flv Maca Verde Granismith Kg' },
            { cod: 2294, name: 'Flv Mamao Formosa Kg' }, { cod: 2335, name: 'Flv Mamao Papaya Kg' }, { cod: 4743, name: 'Flv Mandioca Kg' },
            { cod: 81732, name: 'Flv Manga Hadem Kg' }, { cod: 13988, name: 'Flv Manga Palmer Kg' }, { cod: 2348, name: 'Flv Maracujá Kg' },
            { cod: 2409, name: 'Flv Melancia Kg' }, { cod: 66664, name: 'Flv Melancia Pingo Doce Kg' }, { cod: 2408, name: 'Flv Melao Espanhol Kg' },
            { cod: 68888, name: 'Flv Melao Rei Kg' }, { cod: 4763, name: 'Flv Milho Verde Un Band' }, { cod: 57998, name: 'Flv Mirtilo Kg' },
            { cod: 2530, name: 'Flv Morango Bandeja 220g' }, { cod: 2466, name: 'Flv Moricote Kg' }, { cod: 2561, name: 'Flv Nectarina Kg' },
            { cod: 'ovo-1', name: 'Flv Ovo Band Caipira 10un' }, { cod: 'ovo-2', name: 'Flv Ovo Band Com 20un' },
            { cod: 'ovo-3', name: 'Flv Ovo Band Cordona 30un' }, { cod: 'ovo-4', name: 'Flv Ovo Branco/Verm 12un' },
            { cod: 4842, name: 'Flv Pepino Comum Kg' }, { cod: 4844, name: 'Flv Pepino Japones Kg' }, { cod: 2601, name: 'Flv Pera Wilians Kg' },
            { cod: 84073, name: 'Flv Pera Ya Importada Kg' }, { cod: 2614, name: 'Flv Pessego Kg' }, { cod: 19064, name: 'Flv Phisalis Un' },
            { cod: 4849, name: 'Flv Pimentao Amarelo Kg' }, { cod: 14023, name: 'Flv Pimentao Colorido Bandeja Kg' },
            { cod: 4854, name: 'Flv Pimentao Verde Kg' }, { cod: 4858, name: 'Flv Pimentao Vermelho Kg' }, { cod: 4927, name: 'Flv Pinhao Kg' },
            { cod: 42191, name: 'Flv Pitaya Kg' }, { cod: 2602, name: 'Flv Ponca Kg' }, { cod: 4893, name: 'Flv Quiabo Kg' },
            { cod: 4910, name: 'Flv Repolho Roxo Kg' }, { cod: 4909, name: 'Flv Repolho Verde Kg' }, { cod: 2352, name: 'Flv Tamara Kg' },
            { cod: 85288, name: 'Flv Tangerina Bergamota Kg' }, { cod: 75203, name: 'Flv Tangerina Olé Kg' },
            { cod: 4916, name: 'Flv Tomate Rasteiro/Saladete Kg' }, { cod: 4911, name: 'Flv Tomate Salada Kg' },
            { cod: 43324, name: 'Flv Tomatinho Cereja 180g' }, { cod: 14222, name: 'Flv Uva Benitaka 500g' },
            { cod: 58063, name: 'Flv Uva Niagara 500g' }, { cod: 69583, name: 'Flv Uva Red Globe Bj' },
            { cod: 23335, name: 'Flv Uva Semente Verd Thop Ban' }, { cod: 70767, name: 'Flv Uva Vitoria 500g' },
            { cod: 4921, name: 'Flv Vagem Kg' }
        ];
        
        // Constante dos itens iniciais (usada para resetar)
        const initialItems = parsedData.map(item => ({ ...item, weight: '' }));

        function App() {
            const { useState, useEffect } = React;
            const [items, setItems] = useState(initialItems);
            const [date, setDate] = useState('');
            
            // --- ESTADOS PARA API GEMINI ---
            const [analysis, setAnalysis] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            // --- ESTADOS PARA ITEM TEMPORÁRIO ---
            const [tempName, setTempName] = useState('');
            const [tempWeight, setTempWeight] = useState('');

            /*
            // --- EFEITO PARA LIMPAR APÓS IMPRESSÃO ---
            // Removido temporariamente. Se o problema for resolvido, a limpeza de estado
            // estava interferindo na renderização do PDF.
            useEffect(() => {
                const handleAfterPrint = () => {
                    console.log("Impressão concluída. Resetando o estado...");
                    
                    // 1. Reseta a lista de itens para a original (limpa pesos e itens temp)
                    setItems(initialItems);
                    
                    // 2. Limpa os outros dados da sessão
                    setDate('');
                    setAnalysis('');
                    setError(null);
                    setTempName('');
                    setTempWeight('');
                };

                // Adiciona o listener
                window.addEventListener('afterprint', handleAfterPrint);

                return () => {
                    window.removeEventListener('afterprint', handleAfterPrint);
                };
            }, [initialItems]);
            */

            // Função para atualizar o peso de um item
            const handleWeightChange = (cod, newWeight) => {
                setItems(currentItems =>
                    currentItems.map(item =>
                        item.cod === cod ? { ...item, weight: newWeight } : item
                    )
                );
            };

            // Função para atualizar a data
            const handleDateChange = (e) => {
                setDate(e.target.value); 
            };

            // Função para "exportar" para PDF (gatilho da limpeza)
            const handlePrint = () => {
                window.print();
            };

            // Função para Análise Nutricional (Gemini API)
            const handleAnalyze = async () => {
                setIsLoading(true);
                setError(null);
                setAnalysis('');

                const itemsToAnalyze = items.filter(item => parseFloat(item.weight) > 0);

                if (itemsToAnalyze.length === 0) {
                    setError('Por favor, adicione o peso a pelo menos um item para analisar.');
                    setIsLoading(false);
                    return;
                }

                const prompt = `Com base na lista de itens e seus pesos a seguir, gere um breve resumo nutricional (em 2-3 frases) em português. Foque nos principais benefícios de saúde. Lista: ${itemsToAnalyze
                    .map(i => `${i.name} (${i.weight} Kg)`)
                    .join(', ')}`;

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                try {
                    const response = await fetchWithBackoff(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        setAnalysis(candidate.content.parts[0].text);
                    } else {
                        throw new Error('Resposta da API inválida.');
                    }
                } catch (err) {
                    console.error(err);
                    setError('Não foi possível gerar a análise. Tente novamente mais tarde.');
                } finally {
                    setIsLoading(false);
                }
            };
            
            // Função para Adicionar Item Temporário
            const handleAddTempItem = (e) => {
                e.preventDefault();
                if (!tempName) {
                    // Substituindo alert() por feedback na UI (embora para este caso, vou manter o console.error)
                    console.error("Por favor, insira pelo menos o nome do item.");
                    return;
                }

                const newItem = {
                    cod: `temp_${Date.now()}`,
                    name: `${tempName} (Temp)`,
                    weight: tempWeight || ''
                };

                // Adiciona o novo item no topo da lista
                setItems([newItem, ...items]);

                // Limpa os inputs do formulário
                setTempName('');
                setTempWeight('');
            };


            // Formata a data para exibição
            const formattedDate = date 
                ? new Date(date + 'T00:00:00').toLocaleDateString('pt-BR') 
                : '___ / ___ / ______';

            return (
                <div className="p-6 sm:p-10 max-w-5xl mx-auto font-sans bg-white rounded-xl shadow-lg print:shadow-none print:p-0">
                    
                    {/* --- CABEÇALHO --- */}
                    <div className="flex flex-col sm:flex-row justify-between sm:items-center mb-6 print:mb-4">
                        {/* Título e Data */}
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800 print:text-2xl">
                                Relatório de Pesagem
                            </h1>
                            <div className="flex items-center mt-2 space-x-2">
                                <label 
                                    htmlFor="report-date" 
                                    className="text-lg font-semibold text-gray-700"
                                >
                                    DATA:
                                </label>
                                <input
                                    id="report-date"
                                    type="date"
                                    value={date}
                                    onChange={handleDateChange}
                                    className="p-2 border border-gray-300 rounded-md print:hidden"
                                />
                                <span className="hidden print:block text-lg font-semibold p-2">
                                    {formattedDate}
                                </span>
                            </div>
                        </div>

                        {/* Botões de Ação (Exportar e Analisar) */}
                        <div className="flex flex-col sm:flex-row gap-2 mt-4 sm:mt-0 print:hidden">
                            <button
                                onClick={handlePrint}
                                className="flex items-center justify-center px-5 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200"
                            >
                                <Printer className="mr-2 h-5 w-5" />
                                Exportar para PDF
                            </button>
                            <button
                                onClick={handleAnalyze}
                                disabled={isLoading}
                                className="flex items-center justify-center px-5 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg shadow-md hover:from-purple-600 hover:to-pink-600 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isLoading ? (
                                    <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                                ) : (
                                    <Sparkles className="mr-2 h-5 w-5" />
                                )}
                                {isLoading ? 'Analisando...' : '✨ Analisar Nutrientes'}
                            </button>
                        </div>
                    </div>
                    
                    {/* --- FORMULÁRIO DE ITEM TEMPORÁRIO --- */}
                    <form onSubmit={handleAddTempItem} className="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg print:hidden">
                        <h3 className="text-lg font-semibold text-gray-800 mb-3">
                            Adicionar Item Temporário
                        </h3>
                        <div className="flex flex-col sm:flex-row gap-3">
                            <div className="flex-1">
                                <label htmlFor="temp-name" className="block text-sm font-medium text-gray-700 mb-1">
                                    Nome do Item
                                </label>
                                <input
                                    type="text"
                                    id="temp-name"
                                    value={tempName}
                                    onChange={(e) => setTempName(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-md w-full"
                                    placeholder="Ex: Uva Importada Especial"
                                />
                            </div>
                            <div className="w-full sm:w-1/3">
                                <label htmlFor="temp-weight" className="block text-sm font-medium text-gray-700 mb-1">
                                    Peso (Opcional)
                                </label>
                                <input
                                    type="number"
                                    id="temp-weight"
                                    step="0.01"
                                    value={tempWeight}
                                    onChange={(e) => setTempWeight(e.target.value)}
                                    className="p-2 border border-gray-300 rounded-md w-full"
                                    placeholder="0.00"
                                />
                            </div>
                            <button
                                type="submit"
                                className="flex items-center justify-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 sm:self-end"
                            >
                                <PlusCircle className="mr-2 h-5 w-5" />
                                Adicionar
                            </button>
                        </div>
                    </form>


                    {/* --- SEÇÃO DE ANÁLISE GEMINI (VISÍVEL NO PDF) --- */}
                    <div className="my-6 print:mb-4">
                        {error && (
                            <div className="p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg print:hidden">
                                <p className="font-semibold">Erro</p>
                                <p>{error}</p>
                            </div>
                        )}
                        {analysis && (
                            <div className="p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm print:bg-white print:border-none print:shadow-none">
                                <h3 className="text-lg font-semibold text-gray-800 mb-2 print:text-lg print:font-bold print:text-gray-900">
                                    Análise Nutricional ✨
                                </h3>
                                <p className="text-gray-700 whitespace-pre-wrap print:text-gray-900">{analysis}</p>
                            </div>
                        )}
                    </div>

                    {/* --- TABELA DE ITENS --- */}
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-[600px] border-collapse print-table">
                            <thead>
                                <tr className="bg-gray-100 print:bg-white border-b-2 border-gray-700 print:border-b-2 print:border-gray-500">
                                    <th className="p-3 text-left text-sm font-bold text-gray-600 print:text-gray-900 uppercase tracking-wider w-[100px]">
                                        Cód
                                    </th>
                                    <th className="p-3 text-left text-sm font-bold text-gray-600 print:text-gray-900 uppercase tracking-wider">
                                        Item
                                    </th>
                                    <th className="p-3 text-left text-sm font-bold text-gray-600 print:text-gray-900 uppercase tracking-wider w-[150px]">
                                        Peso (Kg/Un)
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                {items.map((item) => (
                                    <tr key={item.cod} className="border-b border-gray-200 hover:bg-gray-50 print:hover:bg-white">
                                        <td className="p-3 text-gray-700 font-medium print:text-gray-900">
                                            {item.cod}
                                        </td>
                                        <td className="p-3 text-gray-900">
                                            {item.name}
                                        </td>
                                        <td className="p-3">
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={item.weight}
                                                onChange={(e) => handleWeightChange(item.cod, e.target.value)}
                                                className="p-2 border border-gray-300 rounded-md w-full print:hidden"
                                                placeholder="0.00"
                                            />
                                            {/* Lógica de exibição de peso simplificada para impressão */}
                                            <span className="hidden print:block p-2 text-gray-900">
                                                {item.weight && !isNaN(parseFloat(item.weight))
                                                    ? parseFloat(item.weight).toFixed(2)
                                                    : '0.00'}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // Renderiza o componente no DOM
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
